<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Category Details</title>
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #f8f9fa;
        }

        .bg_accent {
            background: #1f2937;
        }

        .text_accent {
            color: #1f2937;
        }

        .bg_primary {
            background: #00bfa6;
        }

        .btn_primary {
            background: #00bfa6;
            color: #fff;
        }

        .btn_outline-primary {
            border: 1px solid #00bfa6;
        }

        .text_primary {
            color: #00bfa6;
        }

        .category-header {
            color: #1f2937;
            padding: 10px;
        }

        .category-header .header-title {
            width: 100%;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .spinner-container {
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-message {
            color: #dc3545;
            font-weight: 600;
            text-align: center;
            margin-top: 2rem;
        }

        .category-description {
            margin-top: 1rem;
            font-size: 1.1rem;
        }

        .no-services {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            margin-top: 2rem;
        }

        .services-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding: 20px;
        }

        .service-card {
            flex: 1 1 auto;
            border-radius: 0.75rem;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.09);
            transition: box-shadow 0.2s;
        }

        .service-card:hover {
            background: #96f1e8;
        }

        .service-card a {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
        }

        .service-card:hover {
            box-shadow: 0 4px 16px rgba(0, 191, 166, 0.1);
        }

        .service-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        .service-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--secondary);
        }

        .service-desc {
            font-size: 0.95rem;
            color: #475569;
            margin-bottom: 0.5rem;
        }

        .service-price {
            font-size: 1rem;
            font-weight: 500;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .service-reqs {
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }

        .service-available {
            font-size: 0.85rem;
            color: #22c55e;
            font-weight: 500;
        }

        @media (max-width: 768px) {
        .services-grid {
            gap: 7px;
            padding: 4px;
        }

         .service-card {
                flex: 1 1 30% !important;
            }

            .service-card a {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0;
            }

            .service-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
            }

            .service-title {
                font-size: 0.65rem;
                /* base size */
                font-weight: 600;
                color: var(--secondary);
                white-space: nowrap;
                /* force one line only */
                overflow: hidden;
                /* hide overflow text */
                text-overflow: ellipsis;
            }


            .service-price {
                font-size: 0.7rem;
                font-weight: 500;
                color: var(--primary);
                margin-bottom: 0.5rem;
            }

            .service-available {
                font-size: 0.65rem;
                color: #22c55e;
                font-weight: 500;
            }

            .category-header .header-title {
                font-size: 1.5rem;
                font-weight: 700;
            }
            .category-description {
                font-size: 0.75rem;
            }

        }
    </style>
</head>

<body>
    <main>
        <div id="category-content">
            <div class="spinner-container" id="loading-spinner">
                <div class="spinner-border text_primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </main>

    <script>
        const id = new URLSearchParams(location.search).get('id');
        let page = 1;
        let totalPages = 1;
        let loading = false;
        let searchQuery = '';
        let hasRenderedInitial = false;


function formatService(svc) {
  return `
    <div class="service-card border rounded shadow-sm p-3 mb-4 h-100">
      <a href="/service?id=${svc.id}" class="text-decoration-none text-dark d-block h-100">
        <div class="service-icon mb-2 text-center" style="height: 120px; overflow: hidden;">
          <img 
            src="${svc.icon || '/default-icon.png'}" 
            alt="${svc.name} icon" 
            class="img-fluid w-100 h-100" 
            style="object-fit: cover; border-radius: 8px;" 
          />
        </div>
        <div class="service-title fw-semibold fs-5 text-center">${svc.name}</div>
        ${svc.description ? `<div class="service-description text-muted small mt-1 text-start">${svc.description}</div>` : ''}
      </a>
    </div>
  `;
}



        function renderHeader(category) {
            return `
        <section class="category-header bg_primary text-light">
          <div class="">
            <span class="header-title"><a href="javascript:history.back()" class=" text-light bi bi-chevron-left"></a>${category.name}</span>
            <div class="category-description">${category.description || ''}</div>
          </div>
            <input id="searchInput" class="form-control mt-3" placeholder="Search services...">
        </section>
        <section class="">
          <div id="services-grid" class="services-grid"></div>
          <div id="loadingMore" class="text-center py-3 d-none">
            <div class="spinner-border text_primary" role="status"><span class="visually-hidden">Loading...</span></div>
          </div>
        </section>
      `;
        }

        function showError(msg) {
            document.getElementById('category-content').innerHTML = `<div class="error-message">${msg}</div>`;
        }

        async function fetchAndRenderServices() {
            if (loading || page > totalPages) return;
            loading = true;
            document.getElementById('loadingMore')?.classList.remove('d-none');

            try {
                const res = await fetch(`/api/categories/${id}?page=${page}&q=${encodeURIComponent(searchQuery)}`);
                const json = await res.json();
                if (!json.data?.category) throw new Error('Invalid data');

                const { category, services, pagination } = json.data;
                totalPages = pagination.totalpages;

                if (!hasRenderedInitial) {
                    document.getElementById('category-content').innerHTML = renderHeader(category);
                    document.getElementById('searchInput').addEventListener('input', () => {
                        page = 1;
                        totalPages = 1;
                        searchQuery = document.getElementById('searchInput').value;
                        document.getElementById('services-grid').innerHTML = '';
                        fetchAndRenderServices();
                    });
                    hasRenderedInitial = true;
                }

                const container = document.getElementById('services-grid');
                if (services.length > 0) {
                    container.innerHTML += services.map(formatService).join('');
                } else if (page === 1) {
                    container.innerHTML = `<div class="no-services">No services found.</div>`;
                }

                page++;
            } catch (err) {
                console.error(err);
                showError('Failed to load category/services.');
            } finally {
                loading = false;
                document.getElementById('loadingMore').classList.add('d-none');
            }
        }

        // Infinite scroll
        window.addEventListener('scroll', () => {
            if (
                window.innerHeight + window.scrollY >= document.body.offsetHeight - 200 &&
                !loading &&
                page <= totalPages
            ) {
                fetchAndRenderServices();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            if (!id) {
                showError('No category ID provided.');
                return;
            }
            fetchAndRenderServices();
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>